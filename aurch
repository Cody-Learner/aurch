#!/bin/bash
# aurch 2021-11-27
# dependencies: arch-install-scripts base-devel git *
# * Aurutils is installed and setup in the chroot. Not as a dependency on host.

#========================================================================================================================#

basedir="$(pwd)"						# HOST  base directory		  : /home/<user>/aurbuilds
[[ ! -s ${basedir}/.#ID ]] && mktemp -u XXX > .#ID		# Create unique chroot suffix.
chroot="${basedir}/chroot-$(< .#ID)"				# HOST path to chroot	  	  : /home/<user>/aurbuilds/chroot-xxx
chrbuilduser="/home/builduser"					# CHROOT builduser home directory : /home/builduser
homebuilduser="${basedir}/chroot-$(< .#ID)/home/builduser"	# HOST   builduser home directory : /home/<user>/aurbuilds/chroot-xxx/home/builduser
package="${2,,}"						# Convert <package> to lower case.
[[ ! -v AURREPO ]] && AURREPO="/tmp/aurch"			# HOST  local pacman aur repo.
[[ ! -d ${AURREPO} ]] && mkdir "${AURREPO}"			# Create host AUR repo.
tmpc="/var/tmp/aurch"						# CHROOT tmp dir (used within chroot)
tmph="${chroot}${tmpc}"						# HOST tmp dir   (used on host)
[[ -d ${chroot} && ! -d ${tmph} ]] && mkdir "${tmph}"		# Create aurch tmp directory.
czm=$(echo -e '\033[1;96m'":: aurch ==>"'\033[00m')		# Aurch color pointer.
error=$(echo -e '\033[1;91m' "ERROR:" '\033[00m')		# Red 'ERROR' text.
line2=$(printf %"$(tput cols)"s |tr " " "-")			# Set line '---' to terminal width.

#========================================================================================================================#

help(){
cat << EOF

NAME
	aurch - sets up and builds AUR packages in chroot

DESCRIPTION
	Aurch creates a chroot, sets up aurutils with a local AUR repo*, and sets up 'builduser'* in the directory it's ran in.
	Can be used for various AUR package related tasks including '-B 'for easy one command builds.
	Upon completing AUR build/s, aurch will place copy/s of the package/s in the host AURREPO file.
	Keeps a copy of all AUR packages and dependencies built in the chroot AUR repo for future use.
	Automatically installs all required pgp keys in the chroot.
	Automatically maintains a 144 package count in the chroot via automated cleanup.
	The chroot is intended to be reused.
	Does not perform 'clean chroot' builds.
	The emphasis of this script is using a chroot for 'build isolation' rather than 'clean building'.

	*(within the chroot)

${line2}

Usage:
		aurch [operation] [package | pgp key]


Operations: 
		    --setup		Sets up a chroot
		-B  --build		Builds an AUR package in one step
		-G  --git		Git clones an AUR package
		-C  --compile		Builds an AUR package on existing PKGBUILD
		-L  --listup		List updates. (pkgs in chroot AUR repo, compare local vs remote git HEAD, list mismatches)
		    --clean		Manually remove unneeded packages from chroot
		    --pgp		Manually import pgp key in chroot
		-h, --help		Prints help

Overview:
		Run 'aurch --setup' before using aurch.
		Run aurch from directory containing chroot created during 'aurch --setup'.

Examples:
		Create a directory to setup chroot in:		mkdir ~/aurbuilds
		Move into directory:				cd ~/aurbuilds
		Set up chroot:					aurch --setup		 
		Build an AUR package in the chroot:		aurch -B <aur-package>
		Git clone package				aurch -G <aur-package>
		Build (Compile) AUR pkg on existing PKGBUILD	aurch -C <aur-package>
		List chroot AUR repo package updates:		aurch -L
		Manually import a pgp key in chroot:		aurch --pgp <short or long key id>
		Manually remove unneeded packages in chroot:	aurch --clean

Variables:
		AURREPO </path/to/host/directory>
		AURREPO Default: /tmp/aurch

		To copy built AUR packages to host, set:
		AURREPO="/path/to/host/local-pacman-repo"
Misc:
		Aurch runtime messages will be proceeded with this: ${czm}
		Aurch runtime errors will be proceeded with this: ${czm}${error}

${line2}
EOF
}
#========================================================================================================================#
setup_chroot(){

	mkdir "${chroot}"

	sudo chown root:root "${chroot}"

if	sudo pacstrap "${chroot}" base base-devel git ; then

	echo "${czm} Pacstrap finished chroot install."
	sleep 2

	cd "${chroot}"										|| { echo "[line ${LINENO}]" ; exit 1 ; }

	sudo rm -rd "${chroot}"/var/lib/pacman/sync/*.db
	sudo systemd-nspawn -q 	pacman -Syy							|| { echo "[line ${LINENO}]" ; exit 1 ; }

	sudo systemd-nspawn -q    useradd -m -G wheel -s /bin/bash builduser
	sudo systemd-nspawn -q    mkdir /build
	sudo systemd-nspawn -q    chown builduser:builduser /build

	sudo systemd-nspawn -q sed -i '$a\#'                        /etc/pacman.conf
	sudo systemd-nspawn -q sed -i '$a\# Path to aurt.conf'      /etc/pacman.conf
	sudo systemd-nspawn -q sed -i '$a\Include = /etc/aurt.conf' /etc/pacman.conf
	sudo systemd-nspawn -q sed -i '/CacheDir/s/^#//g'           /etc/pacman.conf
	sudo systemd-nspawn -q sed -i '/ParallelDownloads/s/^#//g'  /etc/pacman.conf
	sudo systemd-nspawn -q sed -i '/VerbosePkgLists/s/^#//g'    /etc/pacman.conf

	echo "${czm} Following is the contents of new file: /etc/aurt.conf"

cat	<<-EOF	  | sudo tee "${chroot}"/etc/aurt.conf

	[options]
	CacheDir    = /build
	CleanMethod = KeepInstalled

	[aur]
	SigLevel = Optional TrustAll
	Server = file:///build

EOF
    else
	echo "${czm} Pacstrap failed."
fi
	cd "${basedir}"										|| { echo "[line ${LINENO}]" ; exit 1 ; }

if	[[ -d  ${chroot}/build ]] && [[ -d ${homebuilduser} ]] ; then

	printf '%s\n' "%wheel ALL=(ALL) NOPASSWD: ALL"  > 01-sudoers-addendum
	sudo chown root:root 01-sudoers-addendum
	sudo mv ./01-sudoers-addendum "${chroot}/etc/sudoers.d/01-sudoers-addendum"

	sudo systemd-nspawn -q   -D "${chroot}"   -u builduser \
	install -d /build -o builduser

	sudo systemd-nspawn -q   -D "${chroot}"   -u builduser \
	repo-add /build/aur.db.tar.gz

	sudo systemd-nspawn -q   -D "${chroot}"  \
	pacman -Sy

	sudo systemd-nspawn -q  -D "${chroot}"  -u builduser --chdir="${chrbuilduser}" --pipe \
	git clone https://aur.archlinux.org/aurutils.git
		
	sudo systemd-nspawn -q  -D "${chroot}"  -u builduser --chdir="${chrbuilduser}"/aurutils --pipe \
	makepkg -si --noconfirm

	sudo pacman	-r "${chroot}" \
			-b "${chroot}/var/lib/pacman/" \
			--config "${chroot}/etc/pacman.conf" \
			--noconfirm -Qq \
			| nl > .#orig-pkgs.log

	if	[[ -e  aurch.README ]]; then
		rm aurch.README
	fi
	cat <<-EOF | tee >( sed 's/\x1B\[[0-9;]*[A-Za-z]//g' >aurch.README)
	${czm} Setup completed.
	${czm} Chroot has base, base-devel, git, and aurutils installed.
	${czm} User builduser is set up, no password required for sudo.
	${czm} Local chroot AUR repo is setup as /build.
	${czm} Do not alter files proceeded with '#.' in base directory.
EOF
    else
	echo; echo "${czm} User setup failed."
fi

}
#========================================================================================================================#

is_it_available(){

	check=$(curl --compressed -s "https://aur.archlinux.org/rpc/?v=5\&type=info&arg\[\]=${package}" \
		| jshon -e results -a -e  Name \
		| awk -F\" '{print $2}')

if	[[ ${package} != "${check}" ]] ; then
	echo "${czm}${error}\"${package}\" not available. See: https://aur.archlinux.org/packages/"
	exit
fi

}
#========================================================================================================================#

fetch_pkg(){

	is_it_available

	sudo systemd-nspawn -q -D "${chroot}" -u builduser --chdir="${chrbuilduser}" \
	aur fetch -Sr "${package}" | tee >(awk -F\' '/Cloning/ {print $2}' >"${tmph}"/cloned-pkgs.file)
	#[SAVE] -S Alias for --sync=auto
	#[SAVE] -r Download packages and their dependencies

if	[[ -s ${tmph}/cloned-pkgs.file ]]; then
	echo "${czm} Git cloned ${package} and/or it's dependencies:"
	nl "${tmph}"/cloned-pkgs.file
fi

}
#========================================================================================================================#

build_pkg(){

	rm -f "${tmph}"/*.file

	cacheB=$(find "${AURREPO}"/*pkg.tar* 2>/dev/null |sort)

	find "${chroot}"/build/*pkg.tar* 2>/dev/null >"${tmph}"/before.file

	cd "${homebuilduser}"									|| { echo "[line ${LINENO}]" ; exit 1 ; }

	sudo systemd-nspawn -q -D "${chroot}" -u builduser --chdir="${chrbuilduser}" --pipe bash << EOF
	aur depends -b "${package}" >"${tmpc}"/buildorder.file
	aur depends -n "${package}" | grep -v "${package}" >"${tmpc}"/dependencies.file
EOF
	echo "${czm} Buildorder list for ${package}:"
	nl "${tmph}"/buildorder.file

	echo "${czm} AUR dependencies list for ${package}:"
	nl "${tmph}"/dependencies.file

	readarray -t -O1 buildorder <"${tmph}"/buildorder.file

	depi=$(( ${#buildorder[*]} - 1 ))
	pkgi="${#buildorder[*]}"

for	dependency in "${buildorder[@]:0:${depi}}"
    do

	cd "${homebuilduser}/${dependency}"							|| { echo "[line ${LINENO}]" ; exit 1 ; }
	package="${dependency}"

	fetch_pgp_key

	echo "${czm} Building and installing ${buildorder[${pkgi}]} dependency: ${dependency}"

	sudo systemd-nspawn -q -D "${chroot}" -u builduser --chdir="${chrbuilduser}/${dependency}" --pipe \
	aur build -ns --margs -i
    done
        echo  "${czm} Building: ${buildorder[${pkgi}]}"

	cd "${homebuilduser}/${buildorder[${pkgi}]}"						|| { echo "[line ${LINENO}]" ; exit 1 ; }
	package="${buildorder[${pkgi}]}"

	fetch_pgp_key

	sudo systemd-nspawn -q -D "${chroot}" -u builduser --chdir="${chrbuilduser}/${buildorder[pkgi]}" --pipe bash << EOF
	aur build -fnsr |& tee >(grep 'WARNING:' >"${tmpc}"/warning.file) | tee >(grep 'Adding package' >"${tmpc}"/pkg-nv.file)
EOF
	find "${chroot}"/build/*pkg.tar* 2>/dev/null >"${tmph}"/after.file

	comm -23 <(sort "${tmph}"/after.file) <(sort "${tmph}"/before.file) >"${tmph}"/move.file

	for pkg in $(< "${tmph}"/move.file)
    do
	cp "${pkg}" "${AURREPO}" 						|| { echo "${czm}${error} copying package to AURREPO." ; exit 1 ; }
	basename "${pkg}" >> "${tmph}"/moved.file
    done
	cleanup_chroot

if	[[ -s  ${tmph}/moved.file ]] ; then
	echo "${czm} Copied AUR package/s to host AURREPO:"
	nl "${tmph}"/moved.file
    else						# If a [r]e[b]uilt [p]ackage
	if	[[ -s "${tmph}"/warning.file ]]; then
		rbp=$(awk -F\' '{print $2}' "${tmph}"/pkg-nv.file)
		cp "${chroot}/build/${rbp}" "${AURREPO}"		|| { echo "${czm}${error} copying rebuilt package to AURREPO." ; exit 1 ; }
		echo "${czm} Copied rebuilt AUR package to host AURREPO:"
		echo " ${rbp}"
	fi							# If AURREPO is different after transaction, print diff to added-pkgs.file.
fi								# "added-pkgs.file" used for test in "upd_aur_db" function.
								# Note: Rebuilding a 'same version' package is not a notable difference.
	cacheA=$(find "${AURREPO}"/*pkg.tar*|sort)
	comm -23 <(printf '%s\n' "${cacheA}") <(printf '%s\n' "${cacheB}") | tee > "${tmph}"/added-pkgs.file
	upd_aur_db
}
#========================================================================================================================#

upd_aur_db(){

if	find ${AURREPO}/*.db.tar.gz &>/dev/null && [[ -s "${tmph}"/added-pkgs.file ]]; then
	echo "${czm} Adding package/s to host 'AURREPO' database"

	for pkg in $(< "${tmph}"/added-pkgs.file)
   do
	repo-add "${AURREPO}"/aur.db.tar.gz "${pkg}"
   done
    else
	echo "${czm} No changes detected in AURREPO."
	echo " To install rebuilt same version as installed package, use 'pacman -S'."
fi
}
#========================================================================================================================#

check_updates(){

	sudo -v

	echo "${czm} Comparing local vs remote git HEAD on:"

	rm -f "${homebuilduser}"/updates.file

	readarray -t list < <(pacman	-r "${chroot}"                       \
					-b "${chroot}"/var/lib/pacman/       \
					--config "${chroot}"/etc/pacman.conf \
					-Slq aur)
	for pkgs in "${list[@]}"
    do
	cd "${homebuilduser}" 									|| { echo "[line ${LINENO}]" ; exit 1 ; }

	if	! cd "${pkgs}" 2>/dev/null ; then
		echo "${pkgs}" > "${tmph}"/pkgs.file

		sudo systemd-nspawn -q -D "${chroot}" -u builduser --chdir="${chrbuilduser}" --pipe bash << EOF
		aur depends -b "${pkgs}" | head -1 >"${tmpc}"/pkgs-basename.file
EOF
												# ${vars} are expanded before it's here docked.
		pkgs=$(< "${tmph}"/pkgs-basename.file)
		echo "Checking: $(< "${tmph}"/pkgs.file) [Basename next line]:"
		cd "${pkgs}"									|| { echo "[line ${LINENO}]" ; exit 1 ; }
	fi
	if	[[ -s PKGBUILD ]] ; then
		C3=$(git ls-remote https://aur.archlinux.org/"${pkgs}".git HEAD| head -1 | awk '{print $1}')
		C4=$(git rev-parse HEAD)

			if	[[ ${C3} != "${C4}" ]]; then
				echo "${pkgs}"	>> "${tmph}"/updates.file
			    else
				echo "Checking: ${pkgs}"
			fi
	fi 
    done

if	[[ -s  ${tmph}/updates.file ]]; then
	echo "${czm} Updates available."
	awk '!x[$0]++' "${tmph}"/updates.file
    else
	echo "${czm} No updates available."
fi

}
#========================================================================================================================#

fetch_pgp_key(){

	echo "${czm} Checking pgp key for ${package}."

if	[[ -e .SRCINFO ]]; then
	sudo systemd-nspawn -q -D "${chroot}" -u builduser --chdir="${chrbuilduser}/${package}" --pipe \
	awk '/validpgpkeys/ {print $3}' .SRCINFO >pgp-keys.file					# SC2024: Is not ran as sudo within chroot.
    else
	sudo systemd-nspawn -q -D "${chroot}" -u builduser --chdir="${chrbuilduser}/${package}" --pipe \
	makepkg --printsrcinfo | awk '/validpgpkeys/ {print $3}' >pgp-keys.file
fi
if	[[ -s pgp-keys.file ]] ; then
	for key in $(< pgp-keys.file); do
	sudo systemd-nspawn -q -D "${chroot}" -u builduser --chdir="${chrbuilduser}/${package}" --pipe bash << EOF
	gpg --keyserver keyserver.ubuntu.com --recv-key "${key}" 2>&1 | grep -v 'insecure memory'
EOF
	done
    else
	rm pgp-keys.file
fi

}
#========================================================================================================================#

cleanup_chroot(){

if	[[ ! -e ${tmph}/orig-pkgs.log ]]; then
	awk '{print $2}'  "${basedir}"/.#orig-pkgs.log | sort  >"${tmph}"/orig-pkgs.log
fi
	echo "${czm} Checking/Cleaning chroot."
	sudo systemd-nspawn -q -D "${chroot}" --pipe bash << EOF
	comm -23 <(pacman -Qq) <(cat "${tmpc}"/orig-pkgs.log) \
	| xargs  pacman -Rns --noconfirm 2>/dev/null \
	|| echo " Package count: $(pacman -b "${chroot}/var/lib/pacman/" \
					  --config "${chroot}/etc/pacman.conf" \
					  --noconfirm \
					  -Qq | wc -l). Nothing to do."
EOF
}
#========================================================================================================================#
												
manual_pgp_key(){
	sudo systemd-nspawn -q -D "${chroot}" -u builduser  --pipe \
	gpg --keyserver keyserver.ubuntu.com --recv-key "${key}"				# SC2154: key is assigned in option parsing.
exit

}
#========================================================================================================================#
												# Aurch called with no args message.
if      [[ -z ${*} ]]; then
	echo "Aurch sets up and builds AUR packages in a chroot."
	echo "Chroot ID: $(basename "${chroot}")"
fi

#========================================================================================================================#

while :; do
	case "${1}" in
	-B|--build)		fetch_pkg ; build_pkg						;;
	-G|--git)		fetch_pkg							;;
	-C|--compile)		build_pkg							;;
	-L|--listup)		check_updates							;;
	--clean)		cleanup_chroot							;;
	--setup)		setup_chroot							;;
	--pgp)			key="${2}" manual_pgp_key					;;
	-h|--help)		help								;;
	-?*)                    echo "${czm}${error} Input error. Running --help" ; help	;;
	*)			break
        esac
    shift
done
